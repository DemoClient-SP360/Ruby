#!/usr/bin/env jruby

require_relative "../lib/scorched_earth"

include Java

import java.awt.event.WindowAdapter
import java.awt.event.WindowEvent
import java.awt.image.BufferStrategy
import javax.swing.JFrame
import java.awt.Canvas
import java.awt.Dimension
import javax.swing.JPanel
import java.awt.Color

class GameWindow
  attr_reader :buffer_strategy, :canvas

  def initialize width, height
    @container = JFrame.new
    @canvas    = Canvas.new
    @panel     = @container.get_content_pane

    @panel.set_preferred_size Dimension.new(width, height)
    @panel.set_layout nil
    @panel.add @canvas

    @container.pack
    @container.set_resizable false
    @container.set_visible true

    @canvas.set_bounds 0, 0, width, height

    @canvas.set_ignore_repaint true
    @canvas.create_buffer_strategy 2
    @buffer_strategy = @canvas.get_buffer_strategy
  end

  def run
    last_time = Time.now
    game      = ScorchedEarth::Game.new canvas.width, canvas.height

    game.setup

    loop do
      delta     = Time.now - last_time
      last_time = Time.now
      graphics  = buffer_strategy.get_draw_graphics

      graphics.set_color Color.black
      graphics.fill_rect 0, 0, canvas.width, canvas.height

      game.update delta
      game.render graphics

      graphics.dispose
      buffer_strategy.show

      sleep 1.0/30
    end
  end
end

GameWindow.new(800, 600).run
